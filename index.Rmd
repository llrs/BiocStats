---
title: "Bioconductor stats"
date: "`r base::date()`"
output:
  BiocStyle::html_document2:
    fig_caption: true
    toc_float:
      collapsed: True
      toc_depth: 3
author:
- name: Llu√≠s Revilla
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(collapse = TRUE, warning = TRUE, fig.wide = TRUE)
library("BiocStyle")
library("ggplot2")
library("data.table")
library("zoo")
```

# Introduction

Bioconductor provide [stats of the project](https://www.bioconductor.org/packages/stats/). If you are curious about what is the evolution of the downloads of a certain package or how does the downloads progress with time this is the right place.

Bioconductor classifies the packages in three categories:

 - [Software](http://bioconductor.org/packages/release/BiocViews.html#___Software)
 - [Experimental data](http://bioconductor.org/packages/release/BiocViews.html#___AnnotationData)
 - [Annotation](http://bioconductor.org/packages/release/BiocViews.html#___ExperimentData)

For each category a page with the stats of the packages of each category is provided, together with a file:

 - [Software stats](http://bioconductor.org/packages/stats/)
 - [Experimental data stats](http://bioconductor.org/packages/stats/data-experiment.html)
 - [Annotation stats](http://bioconductor.org/packages/stats/data-annotation.html)
 

As some packages seem to be classified in several categories we first need to classify them.

```{r download}
web <- "https://www.bioconductor.org/packages/stats/" # Base url
colClasses <- c("factor", "character", "character", "numeric", "numeric")
software <- read.delim(paste0(web, "bioc/bioc_pkg_stats.tab"), 
                    colClasses = colClasses)
experimental <- read.delim(paste0(web, "data-experiment/experiment_pkg_stats.tab"), 
                    colClasses = colClasses)
annotation <- read.delim(paste0(web, "data-annotation/annotation_pkg_stats.tab"), 
                    colClasses = colClasses)
# Convert to data.tables
setDT(software)
setDT(experimental)
setDT(annotation)
# Assing Category
software[, Category := "Software"]
experimental[, Category := "Experimental"]
annotation[, Category := "Annotation"]
# Bind
stats <- rbind(software, experimental, annotation)
stats <- stats[Month != "all", , ]
```

# Initial exploratory analysis

We do a little visual exploration of the total downloads per category:
```{r downloads1}
theme_bw <- theme_bw(base_size = 16)
ggplot(stats[ , .(Downloads = sum(Nb_of_downloads)), by = c("Category")]) +
  geom_bar(aes(Category, log10(Downloads), fill = Category), stat = "identity") + 
  theme_bw +
  ylab("log10(Downloads per category)") + 
  ggtitle("Total downloads per category")
```
We can see that Software packages are more downloaded, and Annotation pakcages the least. But is this due to some packages or in general:
```{r boxplot1, fig.cap="Boxplot of downloads per package and category."}
ggplot(stats[ , .(Downloads = log10(sum(Nb_of_downloads))), by = c("Package", "Category")]) +
  geom_violin(aes(Category, Downloads, fill = Category)) + 
  theme_bw +
  ylab("log10(Downloads per package)")
```
It seems that Software packages are as much downloaded as Experimental data and Annotations are less The problem is that some packages are erroniously classified in several categories as you can see if we calculate the overlap between packages:
```{r intersect}
length(intersect(software$Package, experimental$Package))
length(intersect(software$Package, annotation$Package))
length(intersect(experimental$Package, annotation$Package))
```
We need to classify better, we will use the total number of downloads to put them in a single category based in the total downloads for each category:
```{r reclassify}
stats[, .(Packages = length(unique(Package))), by = Category]
# Calculates number of downloads per package and category
max_cat <- stats[, .(Total = sum(Nb_of_downloads)), by = c("Package", "Category")]
# Select the category with max downloads per package
max_cat <- max_cat[, .(Category = Category[which.max(Total)]), by = Package]
# Join by name
stats <- stats[max_cat, , on = "Package"]
# Substitute name
stats <- stats[, -"Category"]
names(stats)[names(stats) == "i.Category"] <- "Category"
stats[, .(Packages = length(unique(Package))), by = Category]
```
Now all the packages are assigned to one category. We look at the boxplot to see if it has changed something:
```{r downloads2, fig.cap="Total number of downloads."}
theme_bw <- theme_bw(base_size = 16)
ggplot(stats[ , .(Downloads = log10(sum(Nb_of_downloads))), by = c("Category")]) +
  geom_bar(aes(Category, Downloads, fill = Category), stat = "identity") + 
  theme_bw +
  ylab("log10(Downloads per category)") + 
  ggtitle("Total downloads per category")
```

```{r boxplot2, fig.cap="Boxplot of downloads per package and category after correction."}
ggplot(stats[ , .(Downloads = log10(sum(Nb_of_downloads))), by = c("Package", "Category")]) +
  geom_violin(aes(Category, Downloads, fill = Category)) + 
  theme_bw +
  ylab("log10(Downloads per package)")
```
We can observe that many packages that where in Annotation are now considered Experimental, also some Software packages changed of category.

To work more easily, we convert the months to a date:
```{r date}
monthsConvert <- function(x) {
  if (x == "Jan") {
    "01"
  } else if (x == "Feb"){
    "02"
  } else if (x == "Mar"){
    "03"
  } else if (x == "Apr"){
    "04"
  } else if (x == "May"){
    "05"
  } else if (x == "Jun"){
    "06"
  } else if (x == "Jul"){
    "07"
  } else if (x == "Aug"){
    "08"
  } else if (x == "Sep"){
    "09"
  } else if (x == "Oct"){
    "10"
  } else if (x == "Nov"){
    "11"
  } else if (x == "Dec"){
    "12"
  }
}
stats$Month <- sapply(stats$Month, monthsConvert)
stats$Date <- as.POSIXct(as.yearmon(paste(stats$Year, stats$Month, sep = "-")), frac = 1)
bioc_packages <- c("BiocInstaller", "Biobase", "BiocGenerics", "S4Vectors", "IRanges", "AnnotationDbi")
stats <- stats[Nb_of_downloads != 0, ]
save(stats, bioc_packages, monthsConvert, file="stats.RData")
```

We can observe the number of packages downloaded for each category along time:
```{r downloaded, fig.cap="Packages downloaded per date and category. For each category the number of packages downloaded are displayed"}
stats2 <- stats[Nb_of_downloads != 0, ] # We remove rows of packages with a download in that month.
theme <- theme(axis.text.x = element_text(angle = 60, hjust = 1))
scal <- scale_x_datetime(date_breaks = "3 months")
ggplot(stats2[, .(Downloaded = .N), by = c("Date", "Category")], aes(Date, Downloaded, color = Category)) +
  geom_line() +
  theme_bw +
  ggtitle("Packages downloaded") +
  theme +
  scal
```
And the number of download per month for each category:
```{r downloas, fig.cap="Downloads per date and category. For each category the downloads are displayed"}
ggplot(stats2[, .(Downloads = sum(Nb_of_downloads)), by = c("Date", "Category")], aes(Date, Downloads, color = Category)) +
  geom_line() +
  theme_bw +
  ggtitle("Packages downloaded") +
  theme +
  scal
```
The number of packages in all three categories increases. In experimental packages it seems that there is a plateau effect, while in Software the number of packages is growing. Annotation packages have peaks of many different packages being downloaded at certain months.
In the contrary the number of downloads in the Annotation category remains relatively stable compared to Experimental and Software packages, which since 2011 increase linearly.with time at a lower peace of the downloaded packages. This suggest that competency for downloads in the software has increased. Looking at the number of downloads per package along time it contradicts our hypothesis:
```{r competitions, fig.cap="Downloads per package. MEan of the downloads per package per category plus the error bars at the 95% CI."}
pd <- position_dodge(0.1)
ggplot(stats2[, .(Number = mean(Nb_of_downloads), 
                  ymin = mean(Nb_of_downloads)-1.96*sd(Nb_of_downloads)/sqrt(.N),
                  ymax = mean(Nb_of_downloads)+1.96*sd(Nb_of_downloads)/sqrt(.N)), 
              by = c("Date", "Category")], aes(Date, Number, color = Category)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width=.1, position=pd) +
  geom_point() + 
  geom_line() +
  theme_bw +
  ggtitle("Downloads") +
  ylab("Mean download for a package") +
  xlab("") + 
  theme +
  scal
```
We can see that for Annotation package the mean download per packages is the same. Experimental packages had much larger variation, but nowadays very few experimental packages are used. In software packages there is much larger variation since two years, but traditionally it had more variation and higher downloads per package than any other category.

We will use this dataset for further analysis for each category:

# Analysis per category
So for each, the same analysis has been performed:
 
 - [Software analysis](software.html)
 - [Experminetal data analysis](experimental.html)
 - [Annotation analysis](annotation.html)

# SessionInfo {.unnumbered}

```{r sessioninfo}
sessionInfo()
```
